<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>WalkieTalkie Firebase</title>
  <style>
    body {
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      background: #111;
      color: #fff;
    }
    #status {
      margin-bottom: 10px;
    }
    button {
      background: #444;
      color: white;
      font-size: 18px;
      padding: 15px 30px;
      border: none;
      border-radius: 10px;
    }
    button.active {
      background: red;
    }
    #indicator {
      margin-top: 20px;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background-color: gray;
    }
  </style>
</head>
<body>
  <div id="status">Connecting...</div>
  <button id="talk">Hold to Talk</button>
  <div id="indicator"></div>

  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD2jt-c0Fdy7TfmEeZR3ChEmxXO1KdJP7M",
      authDomain: "walkietalkie-4bf33.firebaseapp.com",
      databaseURL: "https://walkietalkie-4bf33-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "walkietalkie-4bf33",
      storageBucket: "walkietalkie-4bf33.firebasestorage.app",
      messagingSenderId: "492771509392",
      appId: "1:492771509392:web:6b53c82c3b0c822f934415"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const statusEl = document.getElementById("status");
    const indicator = document.getElementById("indicator");
    const talkBtn = document.getElementById("talk");

    let localStream;
    let peerConnection;
    const servers = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };
    const channel = "walkietalkie-channel";

    async function init() {
      const auth = await firebase.auth().signInAnonymously();
      localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      statusEl.innerText = "Connected. Ready to talk.";
      listenForSignals();
    }

    function sendSignal(data) {
      db.ref(channel).push(data);
    }

    function listenForSignals() {
      db.ref(channel).on("child_added", async snapshot => {
        const data = snapshot.val();
        if (data.sender === myId) return;

        if (data.type === "offer") {
          peerConnection = createPeerConnection();
          await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
          const answer = await peerConnection.createAnswer();
          await peerConnection.setLocalDescription(answer);
          sendSignal({ sender: myId, type: "answer", answer });
        } else if (data.type === "answer" && peerConnection) {
          await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
        } else if (data.type === "candidate" && peerConnection) {
          await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
        }
      });
    }

    function createPeerConnection() {
      const pc = new RTCPeerConnection(servers);
      pc.ontrack = (e) => {
        const remoteAudio = new Audio();
        remoteAudio.srcObject = e.streams[0];
        remoteAudio.play();
        indicator.style.background = 'blue';
        setTimeout(() => indicator.style.background = 'gray', 2000);
      };
      pc.onicecandidate = (e) => {
        if (e.candidate) {
          sendSignal({ sender: myId, type: "candidate", candidate: e.candidate });
        }
      };
      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
      return pc;
    }

    let myId = Math.random().toString(36).substr(2, 9);

    talkBtn.addEventListener("click", async () => {
      talkBtn.classList.add("active");
      indicator.style.background = 'red';
      peerConnection = createPeerConnection();
      const offer = await peerConnection.createOffer();
      await peerConnection.setLocalDescription(offer);
      sendSignal({ sender: myId, type: "offer", offer });
    });

    init();
  </script>
</body>
</html>
