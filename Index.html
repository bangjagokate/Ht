<!DOCTYPE html><html>
<head>
  <meta charset="utf-8">
  <title>Auto Walkie Talkie</title>
  <style>
    body {
      font-family: sans-serif;
      background: #0b0c10;
      color: white;
      text-align: center;
      padding-top: 50px;
    }
    button {
      padding: 15px 30px;
      font-size: 18px;
      margin: 20px;
      border: none;
      border-radius: 10px;
      background: #45a29e;
      color: white;
    }
    .talking {
      background: #66fcf1;
      color: #0b0c10;
    }
    .status {
      margin-top: 20px;
      font-size: 16px;
      color: #aaa;
    }
  </style>
</head>
<body>
  <h1>Walkie Talkie</h1>
  <button id="talkBtn">Mulai Bicara</button>
  <div class="status" id="status">Menunggu koneksi...</div>  <script>
    let localStream;
    let remoteStream = new MediaStream();
    let pc = new RTCPeerConnection({
      iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
    });

    const talkBtn = document.getElementById("talkBtn");
    const status = document.getElementById("status");

    let isTalking = false;

    async function getMic() {
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
        status.textContent = "Mikrofon aktif, membuat koneksi...";
      } catch (e) {
        status.textContent = "Izin mikrofon ditolak!";
        console.error(e);
      }
    }

    pc.ontrack = (event) => {
      event.streams[0].getAudioTracks().forEach(track => {
        remoteStream.addTrack(track);
      });
      const audio = document.createElement("audio");
      audio.srcObject = remoteStream;
      audio.autoplay = true;
    };

    pc.onicecandidate = ({ candidate }) => {
      if (candidate) {
        sendSignal(JSON.stringify(candidate));
      }
    };

    // Simulasi signaling via localStorage (untuk demo lokal 1 device)
    function sendSignal(data) {
      localStorage.setItem("walkie-signal", data);
    }

    window.addEventListener("storage", async (event) => {
      if (event.key === "walkie-signal" && event.newValue) {
        const candidate = JSON.parse(event.newValue);
        try {
          await pc.addIceCandidate(new RTCIceCandidate(candidate));
        } catch (e) {
          console.error(e);
        }
      }
    });

    talkBtn.onclick = () => {
      isTalking = !isTalking;
      localStream.getAudioTracks()[0].enabled = isTalking;
      talkBtn.classList.toggle("talking", isTalking);
      talkBtn.textContent = isTalking ? "Berhenti Bicara" : "Mulai Bicara";
    };

    async function connect() {
      await getMic();
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      localStorage.setItem("walkie-offer", JSON.stringify(offer));
      const interval = setInterval(async () => {
        const answerData = localStorage.getItem("walkie-answer");
        if (answerData) {
          clearInterval(interval);
          const answer = JSON.parse(answerData);
          await pc.setRemoteDescription(answer);
          status.textContent = "Terhubung! Siap bicara.";
        }
      }, 1000);
    }

    async function listen() {
      await getMic();
      const interval = setInterval(async () => {
        const offerData = localStorage.getItem("walkie-offer");
        if (offerData) {
          clearInterval(interval);
          const offer = JSON.parse(offerData);
          await pc.setRemoteDescription(offer);
          const answer = await pc.createAnswer();
          await pc.setLocalDescription(answer);
          localStorage.setItem("walkie-answer", JSON.stringify(answer));
          status.textContent = "Terhubung! Siap bicara.";
        }
      }, 1000);
    }

    // Auto jalankan kedua sisi (untuk testing lokal)
    connect();
    listen();
  </script></body>
</html>
