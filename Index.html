<!DOCTYPE html>
<html>
<head>
  <title>Walkie Talkie Test</title>
  <style>
    body {
      text-align: center;
      font-family: sans-serif;
      background: #000;
      color: white;
      margin-top: 100px;
    }
    button {
      font-size: 24px;
      padding: 20px 40px;
      background-color: red;
      color: white;
      border: none;
      border-radius: 12px;
    }
    button:active {
      background-color: green;
    }
  </style>
</head>
<body>
  <h1>Walkie Talkie Web Test</h1>
  <button id="ptt">Hold to Talk</button>

  <script>
    let localStream;
    let mediaRecorder;
    let ws;

    async function getMicrophone() {
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      } catch (err) {
        alert("Akses mikrofon ditolak!");
        console.error(err);
      }
    }

    async function startRecording() {
      if (!localStream) return;

      mediaRecorder = new MediaRecorder(localStream);
      mediaRecorder.start(100);

      mediaRecorder.ondataavailable = e => {
        if (ws && ws.readyState === 1) {
          ws.send(e.data);
        }
      };
    }

    function stopRecording() {
      if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
      }
    }

    async function initWebSocket() {
      ws = new WebSocket("wss://echo.websocket.events"); // Server testing

      ws.onopen = () => {
        console.log("WebSocket connected.");
      };

      ws.onmessage = e => {
        const blob = new Blob([e.data]);
        const audio = new Audio(URL.createObjectURL(blob));
        audio.play();
      };

      ws.onerror = (e) => {
        console.error("WebSocket error", e);
      };
    }

    // Inisialisasi
    getMicrophone();
    initWebSocket();

    // Event Tombol
    const btn = document.getElementById("ptt");
    btn.addEventListener("mousedown", startRecording);
    btn.addEventListener("mouseup", stopRecording);
    btn.addEventListener("touchstart", startRecording);
    btn.addEventListener("touchend", stopRecording);
  </script>
</body>
</html>
